<html>
  <head>
    <title>Atlanta Hexagon Map</title>
    <script src="https://unpkg.com/h3-js@3.7.2/dist/h3-js.umd.js"></script>
    <script src="https://unpkg.com/deck.gl@^8.0.0/dist.min.js"></script>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v1.4.0/mapbox-gl.js"></script>

    <style type="text/css">
      body {
        font-family: Helvetica, Arial, sans-serif;
        width: 100vw;
        height: 100vh;
        margin: 0;
      }

      #control-panel {
        position: absolute;
        top: 0;
        left: 0;
        margin: 12px;
        padding: 20px;
        font-size: 12px;
        line-height: 1.5;
        z-index: 1;
        background: #fff;
        font-family: Helvetica, Arial, sans-serif;
        box-shadow: 0 0 4px rgba(0, 0, 0, 0.15);
      }

      label {
        display: inline-block;
        width: 140px;
      }
    </style>
  </head>
  <body>
    <div id="control-panel">
        <div>
          <label>Coverage</label>
          <input id="coverage" type="range" min="0" max="1" step="0.1" value="0.9"></input>
          <span id="coverage-value"></span>
        </div>
        <div>
            <label>Opacity</label>
            <input id="opacity" type="range" min="0" max="1" step="0.1" value="0.2"></input>
            <span id="opacity-value"></span>    
          </div>
          <div>
            <label for="color">Color Inversion</label>
            <input id="color" type="checkbox" name="color"></input>
            <span id="color-value"></span>    
          </div>   
      </div>
  </body>

  

  <script type="text/javascript">

    const {DeckGL, H3HexagonLayer, ScatterplotLayer, IconLayer} = deck;
    
    const ICON_MAPPING = {
      marker: {x: 0, y: 0, width: 128, height: 128, mask: true}
    };
    
    d3.csv('dummy_data.csv')
      .then(response => {
      POIdata = response.map(d => [Number(d.stop_lon), Number(d.stop_lat)]);
      console.log(POIdata);
       });


    const deckgl = new DeckGL({
      mapStyle: 'https://basemaps.cartocdn.com/gl/voyager-gl-style/style.json',
      initialViewState: {
        longitude: -84.3880,
        latitude: 33.7490,
        zoom: 11,
        minZoom: 3,
        maxZoom: 17,
        pitch: 20
      },
      controller: true
    });
    
    let data = null;

    const OPTIONS = ['coverage','opacity'];

    const COLOR_RANGE = [
      //[1, 152, 189],
      //[73, 227, 206],
      //[216, 254, 181],
      //[254, 237, 177],
      //[254, 173, 84],
      [209, 55, 78]
    ];

    OPTIONS.forEach(key => {
      document.getElementById(key).oninput = renderLayer;
    });

    document.getElementById('color').oninput = renderLayer;


    function renderLayer () {
        const options = {};
      OPTIONS.forEach(key => {
        const value = document.getElementById(key).value;
        document.getElementById(key + '-value').innerHTML = value;
        options[key] = Number(value);
      });  

      const hexagonLayer = new H3HexagonLayer({
        id: 'heatmap',
        //colorRange: COLOR_RANGE,
        data,
        elevationRange: [0, 0],
        //elevationScale: 300,
        opacity: 0.2,
        wireframe: false,
        filled: true,
        extruded: false,
        pickable: true,
        getHexagon: d=> d.hex,
        //getFillColor: [209, 55, 78],
        getFillColor: d=> {if(document.getElementById('color').checked==true){return [0, (1-d.totpop/5000) * 255, 255]} else{ return [255, (1-d.totpop/5000) * 255, 0]}},
        updateTriggers: {
            getFillColor: document.getElementById('color').checked

        },
        ...options
        //getPosition: d => [d.lon,d.lat],
      });
      
      const scatterplot = new ScatterplotLayer({
            id: 'scatter',
            data: POIdata,
            opacity: 0.8,
            filled: true,
            radiusMinPixels: 2,
            radiusMaxPixels: 3,
            //getRadius: d => 2,
            getPosition: d => [d[0],d[1]],
            getFillColor: d => [0, 128, 255],
            pickable: true,
         
       });
       
      const iconlayer = new IconLayer({
        id: 'icon-layer',
        data: POIdata,
        pickable: true,
        // iconAtlas and iconMapping are required
        // getIcon: return a string
        iconAtlas: 'https://raw.githubusercontent.com/visgl/deck.gl-data/master/website/icon-atlas.png',
        iconMapping: ICON_MAPPING,
        getIcon: d => 'marker',

        sizeScale: 9,
        getPosition: d => [d[0], d[1]],
        getSize: d => 1,
        getColor: d => [0, 128, 255]
      });

      deckgl.setProps({
        layers: [iconlayer, 
                 , hexagonLayer 
                 , scatterplot
                 ],
        getTooltip: ({object}) => object && `Total Population: ${object.totpop} \n White: ${(100*object.white/object.totpop).toFixed(2)}% \n Black: ${(100*object.black/object.totpop).toFixed(2)}% \n Native American: ${(100*object.hisp/object.totpop).toFixed(2)}% \n Asian: ${(100*object.asian/object.totpop).toFixed(2)}% \n Num of Census Blocks: ${object.count}`
      });
    }

    d3.csv('lat_lon_to_census_data.csv')
      .then(response => {
      data = response.map(d => ({hex: h3.geoToH3(Number(d.lat), Number(d.lon), 8), lon: Number(d.lon), lat: Number(d.lat), totpop: Number(d.pop_total), white: Number(d.pop_white), black: Number(d.pop_black), hisp: Number(d.pop_indian_alaskan), asian: Number(d.pop_asian)}));
      console.log(data);
      // Calculate the sums and group data (while tracking count)
      data = data.reduce(function(m, d){
          if(!m[d.hex]){
              m[d.hex] = {...d, count: 1};
              return m;
            }
            m[d.hex].totpop += d.totpop;
            m[d.hex].white += d.white;
            m[d.hex].black += d.black;
            m[d.hex].hisp += d.hisp;
            m[d.hex].asian += d.asian;
            m[d.hex].count += 1;
            return m;
        },{});
        
      // Create new array from grouped data and compute the average
      data = Object.keys(data).map(function(k){
          item  = data[k];
          return {
              hex: item.hex,
              totpop: item.totpop,
              count: item.count,
              white: item.white,
              black: item.black,
              hisp: item.hisp,
              asian: item.asian
            }
      })
      
      console.log(data);
      renderLayer();
    });
  </script>
</html>
